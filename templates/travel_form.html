{% extends "base.html" %}
{% block content %}

<div class="container mt-5" style="background: linear-gradient(to right, #e0f7fa, #fff);">
  <h2 class="mb-1">âœˆï¸ Plan Your Trip</h2>
  <p class="text-muted mb-4">Find the best flights, fast.</p>

  {% if errors %}
  <div class="alert alert-danger">
    <h5 class="mb-2">âš ï¸ Please fix the following:</h5>
    <ul class="mb-0">
      {% for error in errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <form id="searchForm" method="POST" action="/search-flights" class="card p-4 shadow-sm">

    <div class="mb-3">
      <label for="origin_code" class="form-label">From</label>
      <input type="text" class="form-control" id="origin_code" name="origin_code"
             list="origin_code-list"
             value="{% if form_data %}{{ form_data.origin_code }}{% else %}Stockholm Arlanda (ARN){% endif %}"
             placeholder="Enter city or airport" />
      <datalist id="origin_code-list"></datalist>
    </div>

    <div class="mb-3">
      <label for="destination_code" class="form-label">To</label>
      <input type="text" class="form-control" id="destination_code" name="destination_code"
             list="destination_code-list"
             value="{{ form_data.destination_code if form_data else 'London Heathrow (LHR)' }}"
             placeholder="Enter city or airport" />
      <datalist id="destination_code-list"></datalist>
    </div>

    <div class="mb-3">
      <label class="form-label" for="trip_type">ğŸ§­ Trip Type</label>
      <select id="trip_type" name="trip_type" class="form-select" required>
        <option value="one-way" {% if form_data and form_data.trip_type == 'one-way' %}selected{% endif %}>One-way</option>
        <option value="round-trip" {% if not form_data or form_data.trip_type == 'round-trip' %}selected{% endif %}>Round-trip</option>
        <option value="multi-city" {% if form_data and form_data.trip_type == 'multi-city' %}selected{% endif %}>Multi-city</option>
      </select>
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="direct_only" name="direct_only"
             {% if form_data and form_data.direct_only %}checked{% endif %}>
      <label class="form-check-label" for="direct_only">ğŸ›« Show only direct flights</label>
    </div>

    <div class="mb-3">
      <label class="form-label" for="date_from">ğŸ“… Depart</label>
      <input type="date" id="date_from" name="date_from" class="form-control" required
             value="{{ session.last_search.departure if session.last_search else form_data.date_from if form_data else '2026-03-12' }}">
    </div>

    <div class="mb-3" id="returnDateGroup"
        style="{% if form_data and form_data.trip_type == 'one-way' %}display:none;{% endif %}">
      <label class="form-label" for="date_to">ğŸ“… Return</label>
      <input type="date" id="date_to" name="date_to" class="form-control"
            value="{{ session.last_search.return if session.last_search else form_data.date_to if form_data else '2026-03-17' }}"
            {% if not form_data or form_data.trip_type == 'round-trip' %}required{% endif %}>
    </div>
    
<div id="multiCityGroup" style="display:none;" class="mt-4 p-3 border rounded bg-light">
  <h5>âœˆï¸ Leg 2</h5>
  <div class="mb-3">
    <label for="destination_code_2" class="form-label">To (Second Destination)</label>
    <input type="text" class="form-control" id="destination_code_2" name="destination_code_2" 
           list="destination_code-list" placeholder="Where next?">
  </div>
  <div class="mb-3">
    <label class="form-label" for="date_from_2">ğŸ“… Date for Leg 2</label>
    <input type="date" id="date_from_2" name="date_from_2" class="form-control">
  </div>
</div>


    <div class="mb-3">
      <label class="form-label" for="passengers">ğŸ‘¥ Passengers</label>
      <input type="number" id="passengers" name="passengers" class="form-control" min="1" required
             value="{{ form_data.passengers if form_data else 1 }}">
    </div>

    <div class="mb-3">
      <label class="form-label" for="cabin_class">ğŸ’º Cabin Class</label>
      <select id="cabin_class" name="cabin_class" class="form-select" required>
        <option value="economy" {% if not form_data or form_data.cabin_class == 'economy' %}selected{% endif %}>Economy</option>
        <option value="business" {% if form_data and form_data.cabin_class == 'business' %}selected{% endif %}>Business</option>
        <option value="first" {% if form_data and form_data.cabin_class == 'first' %}selected{% endif %}>First</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="limit" class="form-label">Max Flights to Show</label>
      <select class="form-select" name="limit" id="limit">
        <option value="4" {% if not form_data or form_data.limit == "4" %}selected{% endif %}>4</option>
        <option value="8" {% if form_data and form_data.limit == "8" %}selected{% endif %}>8</option>
        <option value="12" {% if form_data and form_data.limit == "12" %}selected{% endif %}>12</option>
        <option value="16" {% if form_data and form_data.limit == "16" %}selected{% endif %}>16</option>
      </select>
    </div>

    <div id="loading" class="text-center mb-3" style="display:none;">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">ğŸ”„ Searching flightsâ€¦ hang tight!</p>
    </div>

    <button type="submit" class="btn btn-primary">Search Flights</button>
  </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    // 1. Define the elements
    var $tripType = $('#trip_type');
    var $returnDateGroup = $('#returnDateGroup');
    var $returnDateInput = $('#date_to');
    
    // Multi-city elements (Ensure these IDs exist in your HTML)
    var $multiCityGroup = $('#multiCityGroup');
    var $dest2Input = $('#destination_code_2');
    var $date2Input = $('#date_from_2');

    function toggleTripFields() {
        var selected = $tripType.val();

        // --- Reset everything first ---
        $returnDateGroup.hide();
        $multiCityGroup.hide();
        $returnDateInput.prop('required', false);
        $dest2Input.prop('required', false);
        $date2Input.prop('required', false);

        // --- Apply logic based on selection ---
        if (selected === 'round-trip') {
            $returnDateGroup.show();
            $returnDateInput.prop('required', true);
            
            // Clear multi-city values
            $dest2Input.val('');
            $date2Input.val('');

        } else if (selected === 'multi-city') {
            $multiCityGroup.show();
            $dest2Input.prop('required', true);
            $date2Input.prop('required', true);
            // âœ… Set the default values when multi-city is selected
            if ($dest2Input.val() === '') {
                $dest2Input.val('Paris (CDG)');
            }
            if ($date2Input.val() === '') {
                $date2Input.val('2026-03-15'); // Format must be YYYY-MM-DD
            }

            // Clear return date value if it was there
            $returnDateInput.val('');

        } else {
            // One-way: Clear all extra values
            $returnDateInput.val('');
            $dest2Input.val('');
            $date2Input.val('');
        }
    }

    // Run on page load
    toggleTripFields(); 

    // Run on change
    $tripType.on('change', toggleTripFields);
});
</script>
<script src="/static/js/flightFinder.js"></script>

{% endblock %}